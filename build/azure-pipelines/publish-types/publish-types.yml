# Publish @types/vscode for each release

trigger:
  branches:
    include: ["refs/tags/*"]

pr: none

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self
    persistCredentials: true

  - task: NodeTool@0
    inputs:
      versionSpec: "16.x"

  - task: AzureKeyVault@1
    displayName: "Azure Key Vault: Get Secrets"
    inputs:
      azureSubscription: "vscode-builds-subscription"
      KeyVaultName: vscode
      SecretsFilter: "github-distro-mixin-password"

  - pwsh: |
      $result = git config --get-regexp .*extraheader ^AUTHORIZATION:
      $token = $result -split "AUTHORIZATION: basic " | Select-Object -Last 1
      "machine github.com
      login vscode
      password $(github-distro-mixin-password)" > ~/.netrc
      git config --global user.email "vscode@microsoft.com"
      git config --global user.name "vscode"
      # "$(github-distro-mixin-password)" | gh auth login --with-token
    displayName: Prepare tooling

  - bash: |
      TAG_VERSION=$(git describe --tags `git rev-list --tags --max-count=1`)
      CHANNEL="C1C14HJ2F"

      if [ "$TAG_VERSION" == "1.999.0" ]; then
        MESSAGE="<!here>. Someone pushed 1.999.0 tag. Please delete it ASAP from remote and local."

        curl -X POST -H "Authorization: Bearer $(SLACK_TOKEN)" \
        -H 'Content-type: application/json; charset=utf-8' \
        --data '{"channel":"'"$CHANNEL"'", "link_names": true, "text":"'"$MESSAGE"'"}' \
        https://slack.com/api/chat.postMessage

        exit 1
      fi
    displayName: Check 1.999.0 tag

  - bash: |
      # Install build dependencies
      (cd build && yarn)
      node build/azure-pipelines/publish-types/check-version.js
    displayName: Check version

  - bash: |
      set -e
      git clone https://github.com/DefinitelyTyped/DefinitelyTyped.git --depth=1
      node build/azure-pipelines/publish-types/update-types.js

      TAG_VERSION=$(git describe --tags `git rev-list --tags --max-count=1`)

      cd DefinitelyTyped

      git diff --color | cat
      git add -A
      git status
      git checkout -b "vscode-types-$TAG_VERSION"
      git commit -m "VS Code $TAG_VERSION Extension API"
      git push origin "vscode-types-$TAG_VERSION"

    displayName: Push update to DefinitelyTyped

  # - pwsh: |
  #     $tagVersion = git describe --tags $(git rev-list --tags --max-count=1)
  #     $body = "Please fill in this template.
  #     * [x]  Use a meaningful title for the pull request. Include the name of the package modified.
  #     * [x]  Test the change in your own code. (Compile and run.)
  #     * [x]  [Add or edit tests](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/README.md#my-package-teststs) to reflect the change.
  #     * [x]  Follow the advice from the [readme](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/README.md#make-a-pull-request).
  #     * [x]  Avoid [common mistakes](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/README.md#common-mistakes).
  #     * [x]  [Run `npm test <package to test>`](https://github.com/DefinitelyTyped/DefinitelyTyped/blob/master/README.md#running-tests).
  #     Select one of these and delete the others:

  #     If changing an existing definition:

  #     * [x]  Provide a URL to documentation or source code which provides context for the suggested changes: https://github.com/microsoft/vscode/tree/release/$tagVersion
  #     * [x]  If this PR brings the type definitions up to date with a new version of the JS library, update the version number in the header."

  #     gh pr create --title "Update VS Code typings for VS Code $tagVersion" --body $body --reviewer kieferrm
  #     gh pr merge --auto --delete-branch --squash
  #   displayName: Create PR to DefinitelyTyped
