trigger:
  branches:
    include: ["main", "release/*"]
pr: none

pool:
  vmImage: "ubuntu-latest"

steps:
  - checkout: self
    persistCredentials: true

  - task: NodeTool@0
    inputs:
      versionSpec: "16.x"

  - pwsh: |
      $result = git config --get-regexp .*extraheader ^AUTHORIZATION:
      $basicToken = $result -split "AUTHORIZATION: basic " | Select-Object -Last 1

      git config user.email "vscode@microsoft.com"
      git config user.name "VSCode"

      git remote add distro https://github.com/microsoft/vscode-distro
      git config http.https://github.com/microsoft/vscode-distro.extraheader "AUTHORIZATION: basic $basicToken"
      git fetch distro

    displayName: Add distro remote

  - script: |
      set -e

      # Push main branch into oss/main
      git push distro origin/main:refs/heads/oss/main

      # Push every release branch into oss/release
      git for-each-ref --format="%(refname:short)" refs/remotes/origin/release/* | sed 's/^origin\/\(.*\)$/\0:refs\/heads\/oss\/\1/' | xargs git push distro

      git merge $(node -p "require('./package.json').distro")

    displayName: Sync & Merge Distro
